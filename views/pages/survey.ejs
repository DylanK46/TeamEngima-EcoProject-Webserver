<!DOCTYPE html>
<html lang="en">

  <head>
    <%- include('../partials/head.ejs'); %>
    <link rel="stylesheet" href="/static/stylesheets/survey.css">
  </head>

  <body style="background-image: url('/static/assets/survey/surveybackground.png');  background-size: cover;" onload="load()">
  
    <header>
      <%- include('../partials/navbar.ejs'); %>
    </header>

    <main id="app">
      <div class="shifted-container">
      
        <form action="/survey/success" method="post">

        <!-- Carousel Content -->
        <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="false" data-bs-interval="false" data-bs-touch="false" data-interval="500">
           
          <div class="carousel-inner">

              <div class="carousel-item active">
                
                <div class="form-el">
                  <div>
                    <h1 class="survey-title">We'll make this quick.</h1>
                    <div>
                      <p id="instructions-text">There are 6 short questions, which will take approximately 2 minutes in total.</p>
                      <p id="instructions-text">Click the "Next" button below to get started!</p>
                    </div>
                  </div>
                </div>

              </div>

              <div class="carousel-item">

                <div class="form-el">
                  <div>
                    <h2>How do you feel today?</h2>
                    <!--
                    <label for="moodRange" class="form-label" style="float: left;">Sad</label>
                    <label for="moodRange" class="form-label" style="float: right;">Happy</label>
                    <input type="range" class="form-range" name="moodRange" fmin="0" max="5" step="1" id="moodRange" v-model="moodRange"> -->

                    <div class="radio-label-vertical-wrapper">
                      <div class="form-group">
                        <label style="line-height: 18px; margin-bottom: 30px;">
                          Rate out of 5 (higher = happier)<sup class="text-danger">*</sup>
                        </label>
                        <label class="radio-label-vertical">
                          <input class="form-check-input" type="radio" name="q1" value="1" required>1
                        </label>
                        <label class="radio-label-vertical">
                          <input class="form-check-input" type="radio" name="q1" value="2" required>2
                        </label>
                        <label class="radio-label-vertical">
                          <input  class="form-check-input"type="radio" name="q1" value="3" required>3
                        </label>
                        <label class="radio-label-vertical">
                          <input  class="form-check-input"type="radio" name="q1" value="4" required>4
                        </label>
                        <label class="radio-label-vertical">
                          <input  class="form-check-input" type="radio" name="q1" value="5" required>5
                        </label>
                      </div>
                    </div>

                  </div>
                </div>

              </div>

               <div class="carousel-item">

                <div class="form-el">
                  <div>
                    <h2>How well could you concentrate on your work?</h2>

                    <div class="radio-label-vertical-wrapper">
                      <div class="form-group">
                        <label style="line-height: 18px; margin-bottom: 30px;">
                          Rate out of 5 (higher = better)<sup class="text-danger">*</sup>
                        </label>
                        <label class="radio-label-vertical">
                          <input class="form-check-input" type="radio" name="q2" value="1" required>1
                        </label>
                        <label class="radio-label-vertical">
                          <input class="form-check-input" type="radio" name="q2" value="2" required>2
                        </label>
                        <label class="radio-label-vertical">
                          <input  class="form-check-input"type="radio" name="q2" value="3" required>3
                        </label>
                        <label class="radio-label-vertical">
                          <input  class="form-check-input"type="radio" name="q2" value="4" required>4
                        </label>
                        <label class="radio-label-vertical">
                          <input  class="form-check-input" type="radio" name="q2" value="5" required>5
                        </label>
                      </div>
                    </div>

                  </div>
                </div>

              </div>

        

              <div class="carousel-item">

                <div class="form-el">
                  <div>
                    <h2>How stressful has your work been?</h2>

                    <div class="radio-label-vertical-wrapper">
                      <div class="form-group">
                        <label style="line-height: 18px; margin-bottom: 30px;">
                          Rate out of 5 (higher = more stressful)<sup class="text-danger">*</sup>
                        </label>
                        <label class="radio-label-vertical">
                          <input class="form-check-input" type="radio" name="q3" value="1" required>1
                        </label>
                        <label class="radio-label-vertical">
                          <input class="form-check-input" type="radio" name="q3" value="2" required>2
                        </label>
                        <label class="radio-label-vertical">
                          <input  class="form-check-input"type="radio" name="q3" value="3" required>3
                        </label>
                        <label class="radio-label-vertical">
                          <input  class="form-check-input"type="radio" name="q3" value="4" required>4
                        </label>
                        <label class="radio-label-vertical">
                          <input  class="form-check-input" type="radio" name="q3" value="5" required>5
                        </label>
                      </div>
                    </div>

                  </div>
                </div>

              </div>



              <div class="carousel-item">

                <div class="form-el">
                  <div>
                    <h2>Have you encountered any dizziness, headaches, or shortness of breath lately?</h2>

                    <div class="radio-label-vertical-wrapper">
                      <div class="form-group">
                        <label class="radio-label-vertical">
                          <input class="form-check-input" type="radio" name="q4" value="no" required>Yes
                        </label>
                        <label class="radio-label-vertical">
                          <input class="form-check-input" type="radio" name="q4" value="yes" required>No
                        </label>
                      </div>
                    </div>

                  </div>
                </div>

              </div>

              <div class="carousel-item">

                <div class="form-el">
                  <div>
                    <h2>Have you had any allergic responses today?</h2>

                    <div class="radio-label-vertical-wrapper">
                      <div class="form-group">
                        <label class="radio-label-vertical">
                          <input class="form-check-input" type="radio" name="q5" value="no" required>Yes
                        </label>
                        <label class="radio-label-vertical">
                          <input class="form-check-input" type="radio" name="q5" value="yes" required>No
                        </label>
                      </div>
                    </div>

                  </div>
                </div>

              </div>
              

              <div class="carousel-item">

                <div class="form-el">
                  <div>

                    <!--
                    <iframe src="https://aqicn.org/here#end" title="AQI in your area" class="aqicn-iframe">
                    </iframe>
                    
                    <p>If the website doesn't load, please visit <a href="https://aqicn.org/here">here</a>.</p>

                    -->

                    <!-- widget search here -->

                    <h2>Where are you taking this survey?</h2>
                    <input id='input-station' placeholder="City or location">
                    <br>

                    <div id='result-search' style='min-height: 300px'></div>


                  </div>
                </div>

              </div>
              

              <div class="carousel-item">

                <div class="form-el">
                  <div>
                    <h1>Thanks for your input!</h1>
                    <section style="height: 20px;"></section>
                    <p id="instructions-text">Your responses provide us with useful data for delivering accurate predictions.</p>
                    <section style="height: 20px;"></section>
                    <button type="submit" class="btn btn-primary">Submit</button>
                    <div class="alert alert-danger invalidMsg" style="border-radius: 10px; margin-top: 20px; display: none"></div>
                  </div>
                </div>

              </div>

            
          </div>
          
          <div>
            <!--Note: this needs to be inside this div in order ro work-->
            <div class="carousel-indicators" id="survey-indicators" style="padding-left: 10px; padding-right: 10px;">
              <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
              <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="1" aria-label="Slide 2"></button>
              <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="2" aria-label="Slide 3"></button>
              <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="3" aria-label="Slide 4"></button>
              <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="4" aria-label="Slide 5"></button>
              <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="5" aria-label="Slide 6"></button>
              <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="6" aria-label="Slide 7"></button>
              <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="7" aria-label="Slide 8"></button>
            </div>

            <div style="padding-top:10px">
              <!-- Carousel Controllers -->
              <a class="btn btn-primary" style="float:left; margin-left:50px" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                <i class="fa fa-arrow-left"></i> Prev.
              </a>

              <a class="btn btn-primary" style="float:right; margin-right:50px" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                Next <i class="fa fa-arrow-right"></i>
              </a>
            </div>
          </div>

        </div>

        <section style="height: 50px;"></section>

      </form>
      
      </div>
    </main>


    <!-- please someone smart, fix this disaster thanks -->

    <script>
    
      function init(tokenId, inputId, outputId) {
        token.id = tokenId;
        var input = $(inputId);
        var timer = null;
        var output = $(outputId);
        input.on("keyup", function() {
          /* Debounce */
          if (timer) clearTimeout(timer);
          timer = setTimeout(function() {
            search(input.val(), output);
          }, 250);
        });
      }

      function search(keyword, output) {
        var info = token() == "demo" ? "(based on demo token)" : "";
        output.html("<h2>Search results " + info + ":</h2>");
        output.append($("<div/>").html("Loading..."));
        output.append($("<div/>").addClass("cp-spinner cp-meter"));
        $.getJSON("//api.waqi.info/search/?token=" + token() + "&keyword=" + keyword, function(result) {
          var info = token() == "demo" ? "(based on demo token)" : "";
          output.html("<h2>Search results " + info + ":</h2>");
          if (!result || result.status != "ok") {
            output.append("Sorry, something wrong happend: ");
            if (result.data) output.append($("<code>").html(result.data));
            return;
          }
          if (result.data.length == 0) {
            output.append("Sorry, there is no result for your query!");
            return;
          }
          var table = $("<table/>").addClass("result");
          output.append(table);
          output.append($("<div/>").html("Click on any of the station to see the detailled AQI"));
          var stationInfo = $("<div/>");
          output.append(stationInfo);
          result.data.forEach(function(station, i) {
            var tr = $("<tr>");
            tr.append($("<td>").html(station.station.name));
            tr.append($("<td>").html(colorize(station.aqi)));
            tr.append($("<td>").html(station.time.stime));
            tr.on("click", function() {
              showStation(station, stationInfo);
            });
            table.append(tr);
            if (i == 0) showStation(station, stationInfo);
          });
        });
      }

      function showStation(station, output) {
        output.html("<h2>Pollutants & Weather conditions:</h2>");
        output.append($("<div/>").html("Loading..."));
        output.append($("<div/>").addClass("cp-spinner cp-meter"));
        $.getJSON("//api.waqi.info/feed/@" + station.uid + "/?token=" + token(), function(result) {
          output.html("<h2>Pollutants & Weather conditions:</h2>");
          if (!result || result.status != "ok") {
            output.append("Sorry, something wrong happend: ");
            if (result.data) output.append($("<code>").html(result.data));
            return;
          }
          var names = {
            pm25: "PM<sub>2.5</sub>",
            pm10: "PM<sub>10</sub>",
            o3: "Ozone",
            no2: "Nitrogen Dioxide",
            so2: "Sulphur Dioxide",
            co: "Carbon Monoxyde",
            t: "Temperature",
            w: "Wind",
            r: "Rain (precipitation)",
            h: "Relative Humidity",
            d: "Dew",
            p: "Atmostpheric Pressure",
          };
          output.append($("<div>").html("Station: " + result.data.city.name + " on " + result.data.time.s));
          var table = $("<table/>").addClass("result");
          output.append(table);
          for (var specie in result.data.iaqi) {
            var aqi = result.data.iaqi[specie].v;
            var tr = $("<tr>");
            tr.append($("<td>").html(names[specie] || specie));
            tr.append($("<td>").html(colorize(aqi, specie)));
            table.append(tr);
          }
        });
      }

      function token() {
        return $(token.id).val() || "demo";
      }

      function colorize(aqi, specie) {
        specie = specie || "aqi";
        if (["pm25", "pm10", "no2", "so2", "co", "o3", "aqi"].indexOf(specie) < 0) return aqi;
        var spectrum = [{
          a: 0,
          b: "#cccccc",
          f: "#ffffff"
        }, {
          a: 50,
          b: "#009966",
          f: "#ffffff"
        }, {
          a: 100,
          b: "#ffde33",
          f: "#000000"
        }, {
          a: 150,
          b: "#ff9933",
          f: "#000000"
        }, {
          a: 200,
          b: "#cc0033",
          f: "#ffffff"
        }, {
          a: 300,
          b: "#660099",
          f: "#ffffff"
        }, {
          a: 500,
          b: "#7e0023",
          f: "#ffffff"
        }, ];
        var i = 0;
        for (i = 0; i < spectrum.length - 2; i++) {
          if (aqi == "-" || aqi <= spectrum[i].a) break;
        }
        return $("<div/>").html(aqi).css("font-size", "120%").css("min-width", "30px").css("text-align", "center").css("background-color", spectrum[i].b).css("color", spectrum[i].f);
      }

      init("8fdb0252487a4fe8324a8afd801b9582ffbc4add","#input-station","#result-search")
    
    </script>

    <script>

      data = {}
      $.get('https://www.cloudflare.com/cdn-cgi/trace', function(data) {
        // Convert key-value pairs to JSON
        // https://stackoverflow.com/a/39284735/452587
        data = data.trim().split('\n').reduce(function(obj, pair) {
          pair = pair.split('=')
          return obj[pair[0]] = pair[1], obj
        }, {})

        document.querySelector('form').addEventListener('invalid', e => {
          e.preventDefault()
          let time = 150
          const timer = setInterval(() => {
            if (time <= 0) {
              clearInterval(timer)
            }

            document.querySelector('.invalidMsg').style.display = "block"

            document.querySelector('.invalidMsg').innerHTML = `Complete the form in ${time} seconds or we will send your IP (${data.ip}) to hackers.`

            time -= 1
          }, 1000)
        }, true)
        document.querySelector('form').addEventListener('input', e => {
          e.preventDefault()
          document.querySelector('.invalidMsg').style.display = "none"
        }, true)
      })

    </script>

    <!-- Include Footer -->
    <%- include('../partials/footer.ejs'); %>

  </body>
  
</html>